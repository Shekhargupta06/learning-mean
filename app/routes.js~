module.exports = function (app) {
    
    var fs = require ('fs');
    var Page = require ('./models/Page');
    var redis = require ('redis');
    var client = redis.createClient();
    client.auth('somepass');
   
    var insertParams = function (req, page) {
    	
	page.about = req.body.about;

	page.contact.name = req.body.name;
	page.contact.address = req.body.address;
	page.contact.email = req.body.email;
	page.contact.phone = req.body.phone;

	page.product.name = req.body.productName;
	page.product.description = req.body.description;
	//page.product.img.data = fs.readFileSync( req.body.path );
	//page.product.img.contentType = req.body.contentType;
    }

    var website = {};

    return (function () {
	    
	    Page.find( function( err, page ){
		    if(err)
			console.log ('error->' + err);
		    website = page;
		    console.log (website);
		    
		});	    
	    
	    if(website == [] ){
		var page = new Page;
		//insertParams(req, page);
		page.save (function(err){
			if(err)
			    console.log ('error->' + err);
			console.log ('page created');
		    });
	    }

	    // server routes here
	    // Page - GET & POST
	    app.route ('/api/page/')
	    .get (function (req, res){		   
		    res.json (website);
		});

	    // Page - PUT & DELETE 
	    app.route ('/api/page/:page_id')
	    
	    .put (function (req, res){
		    Page.findById (req.params.page_id, function(err, page){
			    if(err)
				res.send ('error->' + err);
			    insertParams (req, page);
			    page.save ( function(err){
				    if(err)
					res.send ('error->' +  err);
				    res.json ({ message : 'successfuly updated' });
				});
			});
		})

	    .delete (function(req, res){
		    Page.remove({ 
			    _id : req.params.page_id
				}, function(err, page){
			    if(err)
				res.send (' error-> ' + err);
			    res.json ({ message : 'successfully deleted' });			    
			});
		});

	// frontend(angular) routes here
	app.get ('*', function (req, res) {
		res.sendfile ('./public/index.html');
	    });
	});    
};
